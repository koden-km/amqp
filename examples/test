#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

Eloquent\Asplode\Asplode::install();

use React\EventLoop\Factory;
use Recoil\Amqp\ConnectionException;
use Recoil\Amqp\ConnectionOptions;
use Recoil\Amqp\v091\Amqp091Connector;

$options = ConnectionOptions::create();
$loop = Factory::create();

$connector = new Amqp091Connector($loop);

$connector
    ->connect($options)
    ->then(
        function ($connection) {
            return $connection->channel();
        }
    )
    ->then(
        function ($channel) {
            echo 'Got channel #' . $channel->id() . PHP_EOL;
        }
    )
    ->otherwise(
        function ($error) {
            if ($error instanceof ConnectionException) {
                echo $error->getMessage() . PHP_EOL;
            } else {
                echo $error . PHP_EOL;
            }
        }
    );

$loop->run();
